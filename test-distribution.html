<!DOCTYPE html>
<html>
<head>
    <title>Test Distribuci√≥n Equitativa</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Test de Distribuci√≥n Equitativa por Bloques</h1>
    
    <div class="test-section">
        <h2>Verificaci√≥n de Endpoints</h2>
        <button onclick="testEndpoints()">Probar Endpoints</button>
        <div id="endpoint-results"></div>
    </div>

    <div class="test-section">
        <h2>Datos de Distribuci√≥n</h2>
        <button onclick="testDistribution()">Probar Distribuci√≥n</button>
        <div id="distribution-results"></div>
    </div>

    <script>
        async function testEndpoints() {
            const results = document.getElementById('endpoint-results');
            results.innerHTML = '<p>Probando endpoints...</p>';
            
            try {
                // Test equitable distribution endpoint
                const distributionResponse = await fetch('http://localhost:3000/api/study-plans/96/equitable-distribution');
                const distributionData = distributionResponse.ok ? await distributionResponse.json() : null;
                
                // Test theme parts stats endpoint  
                const partsResponse = await fetch('http://localhost:3000/api/study-plans/96/theme-parts-stats');
                const partsData = partsResponse.ok ? await partsResponse.json() : null;
                
                let html = '<h3>Resultados:</h3>';
                
                // Verificar distribuci√≥n
                if (distributionData && distributionData.distributionByComplexity) {
                    const themes = [
                        ...(distributionData.distributionByComplexity.LOW || []),
                        ...(distributionData.distributionByComplexity.MEDIUM || []),
                        ...(distributionData.distributionByComplexity.HIGH || [])
                    ];
                    
                    const bloques = {
                        'Bloque 1 - Organizaci√≥n': themes.filter(t => t.theme.id >= 1 && t.theme.id <= 6).length,
                        'Bloque 2 - Jur√≠dico-Social': themes.filter(t => t.theme.id >= 7 && t.theme.id <= 14).length,
                        'Bloque 3 - Seguridad Nacional': themes.filter(t => t.theme.id >= 15 && t.theme.id <= 21).length
                    };
                    
                    html += '<h4>Distribuci√≥n por Bloques:</h4><ul>';
                    for (const [bloque, count] of Object.entries(bloques)) {
                        html += `<li class="${count > 0 ? 'success' : 'error'}">${bloque}: ${count} temas</li>`;
                    }
                    html += '</ul>';
                } else {
                    html += '<p class="error">Error al obtener distribuci√≥n</p>';
                }
                
                // Verificar partes
                if (partsData && partsData.themePartsStats) {
                    const temasConPartes = partsData.themePartsStats.filter(t => t.parts.length > 1);
                    
                    html += '<h4>Temas Desglosados:</h4><ul>';
                    temasConPartes.forEach(tema => {
                        html += `<li class="success">${tema.themeName}: ${tema.parts.length} partes</li>`;
                    });
                    
                    if (temasConPartes.length === 0) {
                        html += '<li class="error">No hay temas desglosados</li>';
                    }
                    html += '</ul>';
                } else {
                    html += '<p class="error">Error al obtener estad√≠sticas de partes</p>';
                }
                
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        async function testDistribution() {
            const results = document.getElementById('distribution-results');
            results.innerHTML = '<p>Probando distribuci√≥n...</p>';
            
            try {
                const response = await fetch('http://localhost:3000/api/study-plans/96/equitable-distribution');
                const data = response.ok ? await response.json() : null;
                
                if (data && data.distributionByComplexity) {
                    const themes = [
                        ...(data.distributionByComplexity.LOW || []),
                        ...(data.distributionByComplexity.MEDIUM || []),
                        ...(data.distributionByComplexity.HIGH || [])
                    ];
                    
                    // Agrupar por bloques
                    const bloques = {
                        'Bloque 1 - Organizaci√≥n': themes.filter(t => t.theme.id >= 1 && t.theme.id <= 6),
                        'Bloque 2 - Jur√≠dico-Social': themes.filter(t => t.theme.id >= 7 && t.theme.id <= 14),
                        'Bloque 3 - Seguridad Nacional': themes.filter(t => t.theme.id >= 15 && t.theme.id <= 21)
                    };
                    
                    let html = '<h3>An√°lisis de Equidad por Bloques:</h3>';
                    
                    for (const [bloqueNombre, temasBloque] of Object.entries(bloques)) {
                        if (temasBloque.length > 0) {
                            const sesiones = temasBloque.map(t => t.totalSessions);
                            const maxSesiones = Math.max(...sesiones);
                            const minSesiones = Math.min(...sesiones);
                            const diferencia = maxSesiones - minSesiones;
                            const esEquitativo = diferencia <= 15;
                            
                            html += `<div class="test-section">`;
                            html += `<h4>${bloqueNombre} (${temasBloque.length} temas)</h4>`;
                            html += `<p class="${esEquitativo ? 'success' : 'error'}">`;
                            html += `${esEquitativo ? '‚úÖ' : '‚ö†Ô∏è'} Equidad: ${diferencia} sesiones de diferencia</p>`;
                            html += '<ul>';
                            temasBloque.forEach(tema => {
                                html += `<li>${tema.theme.title}: üìö${tema.totalSessions} üîÑ${tema.reviewSessions} ‚è±Ô∏è${tema.totalHours}h</li>`;
                            });
                            html += '</ul></div>';
                        }
                    }
                    
                    results.innerHTML = html;
                } else {
                    results.innerHTML = '<p class="error">No se pudieron obtener los datos de distribuci√≥n</p>';
                }
                
            } catch (error) {
                results.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>